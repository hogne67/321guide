
<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>Ruteadministrasjon</title>
  <link rel="stylesheet" href="admin-layout.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="sidebarContainer"></div>

  <div class="main">
    <h1>Ruter</h1>

    <label for="routeSelect">Velg rute:</label>
    <select id="routeSelect">
      <option value="">-- Velg en rute --</option>
    </select>

    <div id="routeDetails" style="margin-top: 20px;"></div>

    <h2>Punkter i valgt rute</h2>
    <ul id="poiList"></ul>

    <div id="map" style="height: 400px; margin-top: 20px;"></div>

    <h2>Legg til nytt punkt</h2>
    <label for="poiTitle">Tittel:</label>
    <input type="text" id="poiTitle"><br>
    <label for="poiText">Beskrivelse:</label><br>
    <textarea id="poiText"></textarea><br>
    <label for="latitude">Latitude:</label>
    <input type="text" id="latitude"><br>
    <label for="longitude">Longitude:</label>
    <input type="text" id="longitude"><br>
    <label for="imageFile">Bilde:</label>
    <input type="file" id="imageFile"><br>
    <label for="audioFile">Lyd:</label>
    <input type="file" id="audioFile"><br>
    <button id="savePoi">Lagre punkt</button>

    <h2>Rediger valgt punkt</h2>
    <div id="editPoiSection" style="display:none;">
      <input type="hidden" id="editPoiId">
      <label for="editPoiTitle">Tittel:</label>
      <input type="text" id="editPoiTitle"><br>
      <label for="editPoiText">Beskrivelse:</label><br>
      <textarea id="editPoiText"></textarea><br>
      <label for="editLatitude">Latitude:</label>
      <input type="text" id="editLatitude"><br>
      <label for="editLongitude">Longitude:</label>
      <input type="text" id="editLongitude"><br>
      <label for="editImageFile">Nytt bilde (valgfritt):</label>
      <input type="file" id="editImageFile"><br>
      <label for="editAudioFile">Ny lydfil (valgfritt):</label>
      <input type="file" id="editAudioFile"><br>
      <button id="updatePoi">Oppdater punkt</button>
    </div>
  </div>

  <script>
    fetch("sidebar.html")
      .then(res => res.text())
      .then(html => document.getElementById("sidebarContainer").innerHTML = html);
  </script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script type="module">
    import { db, storage } from './firebase-init.js';
    import {
      collection, getDocs, doc, getDoc, addDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {
      ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    const routeSelect = document.getElementById("routeSelect");
    const routeDetails = document.getElementById("routeDetails");
    const poiList = document.getElementById("poiList");

    let selectedRouteId = null;
    let selectedPoiId = null;

    const map = L.map('map').setView([62.47, 6.15], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let poiMarkers = [];

    async function loadRoutes() {
      const snapshot = await getDocs(collection(db, "routes"));
      snapshot.forEach(docSnap => {
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = docSnap.data().name;
        routeSelect.appendChild(option);
      });
    }

    routeSelect.addEventListener("change", async () => {
      const routeId = routeSelect.value;
      if (!routeId) return;
      selectedRouteId = routeId;

      const routeRef = doc(db, "routes", routeId);
      const routeDoc = await getDoc(routeRef);
      const routeData = routeDoc.data();

      routeDetails.innerHTML = `
        <p><strong>Navn:</strong> ${routeData.name}</p>
        <p><strong>Beskrivelse:</strong> ${routeData.description || "–"}</p>
        <p><strong>Språk:</strong> ${routeData.language}</p>
      `;

      const poiRef = collection(db, `routes/${routeId}/pois`);
      const poiSnap = await getDocs(poiRef);

      poiList.innerHTML = "";
      poiMarkers.forEach(marker => map.removeLayer(marker));
      poiMarkers = [];

      poiSnap.forEach(poiDoc => {
        const poi = poiDoc.data();
        const li = document.createElement("li");
        li.innerHTML = `<strong>${poi.title}</strong> (${poi.lat}, ${poi.lng})`;
        li.style.cursor = "pointer";
        li.addEventListener("click", () => {
          showEditForm(routeId, poiDoc.id, poi);
        });
        poiList.appendChild(li);

        const marker = L.marker([poi.lat, poi.lng])
          .addTo(map)
          .bindPopup(`<strong>${poi.title}</strong><br>${poi.text}`);
        poiMarkers.push(marker);
      });

      if (poiMarkers.length > 0) {
        const group = L.featureGroup(poiMarkers);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    });

    map.on('click', function (e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lng;
    });

    async function uploadFile(file, pathPrefix) {
      const fileRef = ref(storage, `${pathPrefix}/${file.name}`);
      await uploadBytes(fileRef, file);
      return await getDownloadURL(fileRef);
    }

    document.getElementById("savePoi").addEventListener("click", async () => {
      const routeId = routeSelect.value;
      const title = document.getElementById('poiTitle').value;
      const text = document.getElementById('poiText').value;
      const lat = parseFloat(document.getElementById('latitude').value);
      const lng = parseFloat(document.getElementById('longitude').value);
      const imageFile = document.getElementById('imageFile').files[0];
      const audioFile = document.getElementById('audioFile').files[0];

      if (!routeId || !title || isNaN(lat) || isNaN(lng)) {
        alert("Fyll ut rute, tittel og koordinater.");
        return;
      }

      let imageUrl = "";
      let audioUrl = "";

      if (imageFile) imageUrl = await uploadFile(imageFile, `images/${routeId}`);
      if (audioFile) audioUrl = await uploadFile(audioFile, `audio/${routeId}`);

      const poiCollection = collection(db, `routes/${routeId}/pois`);
      await addDoc(poiCollection, {
        title,
        text,
        lat,
        lng,
        imageUrl,
        audioUrl,
        created: new Date()
      });

      alert("Punkt lagret!");
      document.getElementById('poiTitle').value = "";
      document.getElementById('poiText').value = "";
      document.getElementById('latitude').value = "";
      document.getElementById('longitude').value = "";
      document.getElementById('imageFile').value = "";
      document.getElementById('audioFile').value = "";

      routeSelect.dispatchEvent(new Event("change"));
    });

    function showEditForm(routeId, poiId, poi) {
      selectedRouteId = routeId;
      selectedPoiId = poiId;
      document.getElementById('editPoiId').value = poiId;
      document.getElementById('editPoiTitle').value = poi.title;
      document.getElementById('editPoiText').value = poi.text;
      document.getElementById('editLatitude').value = poi.lat;
      document.getElementById('editLongitude').value = poi.lng;
      document.getElementById('editPoiSection').style.display = "block";
    }

    document.getElementById("updatePoi").addEventListener("click", async () => {
      const title = document.getElementById('editPoiTitle').value;
      const text = document.getElementById('editPoiText').value;
      const lat = parseFloat(document.getElementById('editLatitude').value);
      const lng = parseFloat(document.getElementById('editLongitude').value);
      const imageFile = document.getElementById('editImageFile').files[0];
      const audioFile = document.getElementById('editAudioFile').files[0];

      let updateData = { title, text, lat, lng };

      if (imageFile) {
        const imageUrl = await uploadFile(imageFile, `images/${selectedRouteId}`);
        updateData.imageUrl = imageUrl;
      }
      if (audioFile) {
        const audioUrl = await uploadFile(audioFile, `audio/${selectedRouteId}`);
        updateData.audioUrl = audioUrl;
      }

      const poiDocRef = doc(db, `routes/${selectedRouteId}/pois/${selectedPoiId}`);
      await updateDoc(poiDocRef, updateData);

      alert("Punkt oppdatert!");
      document.getElementById('editPoiSection').style.display = "none";
      document.getElementById('editPoiId').value = "";
      selectedPoiId = null;
      routeSelect.dispatchEvent(new Event("change"));
    });

    loadRoutes();
  </script>
</body>
</html>
